---
title: "Beta-binomial Regression Simulation"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    number_sections: true
---

```{r setup, message=FALSE, warning=FALSE}
library(gamlss)
library(gamlss.inf)
library(gamlss.dist)
library(tidyverse)
```


# Fit inflated beta on ZIBB count data

## ZIBB with low coverage

Generate data from ZIBB distribution (no regression):

```{r}
set.seed(2022)
cov <- 5 ## !! small binomial denominator, i.e. low coverage
pars <- expand.grid(nu = seq(0.2, 0.6, 0.1), mu = seq(0.1, 0.3, 0.05), sigma = seq(0.1, 0.3, 0.1), bd = cov) %>%
  slice(rep(1:n(), each = 100))

x <- rZIBB(nrow(pars), pars$mu, pars$sigma, pars$nu, pars$bd)
```

MoM estimates vs. true parameters: 

```{r}
smr <- data.frame(pars, x) %>%
  mutate(frac = x/bd) %>%
  group_by(nu, mu, sigma) %>%
  summarise(weight = sum(frac==0) / length(frac),
            mean = mean(frac[frac>0]),
            var = var(frac[frac>0])) 
smr %>% ggplot(aes(weight, nu)) + 
  geom_point() +
  geom_abline(slope = 1, intercept = 0, color = "red") +
  xlim(0.2, 1) + ylim(0.2, 1) +
  xlab("MoM estimate of nu from frational values") + ylab("True nu from ZIBB regression")
smr %>% ggplot(aes(mean, mu)) + 
  geom_point() +
  geom_abline(slope = 1, intercept = 0, color = "red") +
  xlim(0.1, 0.55) + ylim(0.1, 0.55) +
  xlab("MoM estimate of mu from frational values") + ylab("True mu from ZIBB regression")
smr %>% ggplot(aes(sqrt(var/mean/(1-mean)), sigma)) + 
  geom_point() +
  geom_abline(slope = 1, intercept = 0, color = "red") +
  xlim(0.1, 0.6) + ylim(0.1, 0.6) +
  xlab("MoM estimate of sigma from frational values") + ylab("True sigma from ZIBB regression")
```

Observation: In low coverage data, MoM estimates of all parameters from \textbf{fractional values} are highly biased!


## ZIBB with high coverage

Generate data from BB distribution (no regression):

```{r cars}
set.seed(2022)
cov <- 100 ## !! small binomial denominator, i.e. low coverage
pars <- expand.grid(nu = seq(0.2, 0.6, 0.1), mu = seq(0.1, 0.3, 0.05), sigma = seq(0.1, 0.3, 0.1), bd = cov) %>%
  slice(rep(1:n(), each = 100))

x <- rZIBB(nrow(pars), pars$mu, pars$sigma, pars$nu, pars$bd)
```

MoM estimates vs. true parameters

```{r}
smr <- data.frame(pars, x) %>%
  mutate(frac = x/bd) %>%
  group_by(nu, mu, sigma) %>%
  summarise(weight = sum(frac==0) / length(frac),
            mean = mean(frac[frac>0]),
            var = var(frac[frac>0])) 
smr %>% ggplot(aes(weight, nu)) + 
  geom_point() +
  geom_abline(slope = 1, intercept = 0, color = "red") +
  xlim(0.1, 0.8) + ylim(0.1, 0.8) +
  xlab("MoM estimate of nu from frational values") + ylab("True nu from ZIBB regression")
smr %>% ggplot(aes(mean, mu)) + 
  geom_point() +
  geom_abline(slope = 1, intercept = 0, color = "red") +
  xlim(0.05, 0.4) + ylim(0.05, 0.4) +
  xlab("MoM estimate of mu from frational values") + ylab("True mu from ZIBB regression")
smr %>% ggplot(aes(sqrt(var/mean/(1-mean)), sigma)) + 
  geom_point() +
  geom_abline(slope = 1, intercept = 0, color = "red") +
  xlim(0.1, 0.6) + ylim(0.1, 0.6) +
  xlab("MoM estimate of sigma from frational values") + ylab("True sigma from ZIBB regression")
```

Observation: In high coverage data, MoM estimates of sigma from \textbf{fractional values} is still highly biased.

# Fit inflated beta on BB regression data

## Generate data
```{r}
set.seed(2022)
n <- 100000
x <- sample(seq(-3, 3, 0.2), n, replace = T)
cov <- 5 ## !! small binomial denominator, i.e. low coverage

y <- rBB(n, mu = 0.005*x + 0.05, sigma = 1 / (x+20), bd = cov)
df <- data.frame(x, y, frac = y / cov) %>% filter(frac < 1)

hist(df$frac, freq = F) # distribution of fractions
```

## Estimate parameters by fitting zero-inflated beta on fractions

```{r}
smr <- df %>% 
  mutate(mu = 0.005*x + 0.05, 
         sigma = 1 / (x+15), 
         bd = cov) %>%
  group_by(x, mu, sigma) %>% 
  summarise(weight = sum(frac==0) / length(frac), 
            mean = mean(frac[frac>0]), 
            var = var(frac[frac>0])) %>%
  mutate(nu_fit = weight, 
         mu_fit = mean,
         sigma_fit = sqrt(var/mean/(1-mean)))
```

True parameters vs. estimates from inflated beta fitted on \textbf{fractional values}:

```{r}
smr %>% ggplot() + 
  geom_point(aes(x, nu_fit), color = "darkgrey") + 
  geom_point(aes(x, 0), color = "blue") + 
  xlab("x") + ylab("True nu from BB (blue) & est from IB MoM (grey)")
smr %>% ggplot() + 
  geom_point(aes(x, 1-mu_fit), color = "darkgrey") + 
  geom_smooth(aes(x, 1-mu_fit), method = "lm") +
  geom_point(aes(x, 1-mu), color = "blue") + 
  xlab("x") + ylab("True mu from BB (blue) & est from IB MoM (grey)")
smr %>% ggplot() + 
  geom_point(aes(x, sigma_fit), color = "darkgrey") +
  geom_smooth(aes(x, sigma_fit), method = "lm") +
  geom_point(aes(x, sigma), color = "blue") + 
  xlab("x") + ylab("True sigma from BB (blue) & ests from IB MoM (grey)")
```

Observation: Low coverage and extreme small $\mu$ values induces negative correlation between MoM estimates and true values.

